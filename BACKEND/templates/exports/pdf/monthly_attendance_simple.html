{% extends "exports/pdf/base_simple.html" %}

{% block content %}
<style>
    .info-box {
        margin: 20px 0;
        padding: 15px;
        background-color: #f8f9fa;
        border-left: 4px solid {{ branding.primary_color|default:'#4472C4' }};
    }
    .section-title {
        margin-top: 40px;
        color: {{ branding.primary_color|default:'#4472C4' }};
        border-bottom: 1px solid #ddd;
        padding-bottom: 5px;
    }
    .table-header {
        background-color: {{ branding.primary_color|default:'#4472C4' }};
        color: white;
    }
    .trend-up { color: {{ branding.secondary_color|default:'#2e7d32' }}; }
    .trend-down { color: #d32f2f; }
    .trend-neutral { color: #666; }
    .status-present { color: {{ branding.secondary_color|default:'#2e7d32' }}; }
    .status-late { color: {{ branding.accent_color|default:'#ed6c02' }}; }
    .status-absent { color: #d32f2f; }
    .status-excused { color: #1976d2; }
    .alert-box {
        padding: 15px;
        margin: 15px 0;
        border-left: 4px solid;
    }
    .alert-danger {
        background-color: #f8d7da;
        border-color: #d32f2f;
        color: #721c24;
    }
    .alert-info {
        background-color: #d1ecf1;
        border-color: #0c5460;
        color: #0c5460;
    }
</style>

<!-- Informations du Rapport -->
<div class="info-box">
    <h2 style="margin-top: 0; color: {{ branding.primary_color|default:'#4472C4' }};">Informations du Rapport</h2>
    <p><strong>P√©riode :</strong> {{ month_name }} {{ year }}</p>
    <p><strong>Nombre d'employ√©s :</strong> {{ total_employees }}</p>
    <p><strong>Jours ouvr√©s :</strong> {{ working_days }}</p>
</div>

<!-- Statistiques Globales -->
<h2 class="section-title">Statistiques Globales</h2>

<table>
    <thead class="table-header">
        <tr>
            <th style="width: 25%;">Indicateur</th>
            <th style="width: 25%; text-align: right;">Valeur</th>
            <th style="width: 25%; text-align: right;">Pourcentage</th>
            <th style="width: 25%;">Tendance</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td><strong>Pr√©sences totales</strong></td>
            <td style="text-align: right; font-weight: bold;" class="status-present">{{ stats.total_present }}</td>
            <td style="text-align: right;">{{ stats.present_rate|floatformat:1 }}%</td>
            <td>
                {% if stats.present_trend > 0 %}
                    <span class="trend-up">‚Üó {{ stats.present_trend|floatformat:1 }}%</span>
                {% elif stats.present_trend < 0 %}
                    <span class="trend-down">‚Üò {{ stats.present_trend|floatformat:1 }}%</span>
                {% else %}
                    <span class="trend-neutral">‚Üí {{ stats.present_trend|floatformat:1 }}%</span>
                {% endif %}
            </td>
        </tr>
        <tr>
            <td><strong>Retards</strong></td>
            <td style="text-align: right; font-weight: bold;" class="status-late">{{ stats.total_late }}</td>
            <td style="text-align: right;">{{ stats.late_rate|floatformat:1 }}%</td>
            <td>
                {% if stats.late_trend > 0 %}
                    <span class="trend-down">‚Üó {{ stats.late_trend|floatformat:1 }}%</span>
                {% elif stats.late_trend < 0 %}
                    <span class="trend-up">‚Üò {{ stats.late_trend|floatformat:1 }}%</span>
                {% else %}
                    <span class="trend-neutral">‚Üí {{ stats.late_trend|floatformat:1 }}%</span>
                {% endif %}
            </td>
        </tr>
        <tr>
            <td><strong>Absences</strong></td>
            <td style="text-align: right; font-weight: bold;" class="status-absent">{{ stats.total_absent }}</td>
            <td style="text-align: right;">{{ stats.absent_rate|floatformat:1 }}%</td>
            <td>
                {% if stats.absent_trend > 0 %}
                    <span class="trend-down">‚Üó {{ stats.absent_trend|floatformat:1 }}%</span>
                {% elif stats.absent_trend < 0 %}
                    <span class="trend-up">‚Üò {{ stats.absent_trend|floatformat:1 }}%</span>
                {% else %}
                    <span class="trend-neutral">‚Üí {{ stats.absent_trend|floatformat:1 }}%</span>
                {% endif %}
            </td>
        </tr>
        <tr>
            <td><strong>Heures travaill√©es (total)</strong></td>
            <td style="text-align: right; font-weight: bold;">{{ stats.total_hours|floatformat:0 }}h</td>
            <td style="text-align: right;">-</td>
            <td>-</td>
        </tr>
    </tbody>
</table>

<!-- R√©capitulatif par Employ√© -->
<h2 class="section-title">R√©capitulatif par Employ√©</h2>

<table>
    <thead class="table-header">
        <tr>
            <th style="width: 5%;">N¬∞</th>
            <th style="width: 25%;">Employ√©</th>
            <th style="width: 15%;">D√©partement</th>
            <th style="width: 10%; text-align: center;">Pr√©sent</th>
            <th style="width: 10%; text-align: center;">Retards</th>
            <th style="width: 10%; text-align: center;">Absences</th>
            <th style="width: 10%; text-align: center;">Excus√©s</th>
            <th style="width: 15%; text-align: right;">Taux Pr√©sence</th>
        </tr>
    </thead>
    <tbody>
        {% for employee_stat in employee_stats %}
        {% if employee_stat.attendance_rate < 80 %}
        <tr style="background-color: #fff3cd;">
        {% else %}
        <tr>
        {% endif %}
            <td style="text-align: center;">{{ forloop.counter }}</td>
            <td>{{ employee_stat.employee_name }}</td>
            <td>{{ employee_stat.department|default:"-" }}</td>
            <td style="text-align: center;" class="status-present">{{ employee_stat.present }}</td>
            <td style="text-align: center;" class="status-late">{{ employee_stat.late }}</td>
            <td style="text-align: center;" class="status-absent">{{ employee_stat.absent }}</td>
            <td style="text-align: center;" class="status-excused">{{ employee_stat.excused }}</td>
            <td style="text-align: right; font-weight: bold;">
                {% if employee_stat.attendance_rate >= 95 %}
                    <span class="status-present">{{ employee_stat.attendance_rate|floatformat:1 }}%</span>
                {% elif employee_stat.attendance_rate >= 80 %}
                    <span class="status-late">{{ employee_stat.attendance_rate|floatformat:1 }}%</span>
                {% else %}
                    <span class="status-absent">{{ employee_stat.attendance_rate|floatformat:1 }}%</span>
                {% endif %}
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<!-- Analyse par D√©partement -->
{% if department_stats %}
<h2 class="section-title">Analyse par D√©partement</h2>

<table>
    <thead class="table-header">
        <tr>
            <th style="width: 40%;">D√©partement</th>
            <th style="width: 20%; text-align: center;">Effectif</th>
            <th style="width: 20%; text-align: right;">Taux Pr√©sence</th>
            <th style="width: 20%; text-align: right;">Taux Absence</th>
        </tr>
    </thead>
    <tbody>
        {% for dept in department_stats %}
        <tr>
            <td><strong>{{ dept.name }}</strong></td>
            <td style="text-align: center;">{{ dept.employee_count }}</td>
            <td style="text-align: right;" class="status-present">{{ dept.presence_rate|floatformat:1 }}%</td>
            <td style="text-align: right;" class="status-absent">{{ dept.absence_rate|floatformat:1 }}%</td>
        </tr>
        {% endfor %}
    </tbody>
</table>
{% endif %}

<!-- Alertes -->
{% if alerts %}
<h2 style="margin-top: 40px; color: #d32f2f;">‚ö†Ô∏è Alertes</h2>

<div class="alert-box alert-danger">
    <ul style="margin: 0; padding-left: 20px;">
        {% for alert in alerts %}
        <li><strong>{{ alert.employee_name }}</strong> : {{ alert.message }}</li>
        {% endfor %}
    </ul>
</div>
{% endif %}

<!-- Recommandations -->
<div class="alert-box alert-info">
    <h3 style="margin-top: 0; color: #0c5460;">üìã Recommandations</h3>
    <ul>
        {% if stats.absent_rate > 10 %}
        <li>Le taux d'absence ({{ stats.absent_rate|floatformat:1 }}%) est √©lev√©. Envisager une analyse des causes.</li>
        {% endif %}
        {% if stats.late_rate > 15 %}
        <li>Le taux de retards ({{ stats.late_rate|floatformat:1 }}%) n√©cessite une action corrective.</li>
        {% endif %}
        {% if stats.present_rate >= 95 %}
        <li>Excellent taux de pr√©sence ({{ stats.present_rate|floatformat:1 }}%). Maintenir les bonnes pratiques.</li>
        {% endif %}
    </ul>
</div>

<!-- Signature -->
<div class="signature-section">
    <div class="signature-box" style="width: 100%; text-align: right;">
        <p><strong>Responsable RH / Chef de D√©partement</strong></p>
        <div class="signature-line" style="margin-left: auto; margin-right: 0; width: 300px;">
            Date : {{ current_date|date:"d/m/Y" }}<br>
            Signature et cachet
        </div>
    </div>
</div>
{% endblock %}
